<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4.1: http://docutils.sourceforge.net/" />
<title>Vim プチハックのメモ</title>
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2005-12-18 01:56:14 +0100 (Sun, 18 Dec 2005) $
:Revision: $Revision: 4224 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="vim">
<h1 class="title">Vim プチハックのメモ</h1>
<p>このページには、Vim プチハックをしている間に蓄積したメモを書きます。</p>
<p>対象となるソースのバージョンは7.0から7.1です。
<ul class="simple">
<li><a class="reference" href="http://d.hatena.ne.jp/parasporospa/archive?word=%a5%cf%a5%c3%a5%af">今までに行ったプチハックの一覧</a></li>
<li><a class="reference" href="http://d.hatena.ne.jp/parasporospa/20060712/1152712837">src/README.txtの翻訳</a></li>
<li><a class="reference" href="http://d.hatena.ne.jp/parasporospa/archive?word=gdb">gdbで効率的にvimをデバッグする環境構築の試み</a></li>
<li><a class="reference" href="http://d.hatena.ne.jp/parasporospa/20071126/p1">Code::Blocksでvimをデバッグする</a></li>
</ul>
<div class="contents topic">
<p class="topic-title first"><a id="contents" name="contents">Contents</a></p>
<ul class="auto-toc simple">
<li><a class="reference" href="#id3" id="id22" name="id22">1&nbsp;&nbsp;&nbsp;メモ</a><ul class="auto-toc">
<li><a class="reference" href="#id4" id="id23" name="id23">1.1&nbsp;&nbsp;&nbsp;vim の自動テストを実行するには</a></li>
<li><a class="reference" href="#nv-xxx" id="id24" name="id24">1.2&nbsp;&nbsp;&nbsp;ノーマルモードコマンドの定義はnv_xxx</a></li>
<li><a class="reference" href="#ex-ex-c" id="id25" name="id25">1.3&nbsp;&nbsp;&nbsp;ex コマンドの定義は ex_*.c</a></li>
<li><a class="reference" href="#edit-c" id="id26" name="id26">1.4&nbsp;&nbsp;&nbsp;インサートモードコマンドは edit.c</a></li>
<li><a class="reference" href="#options-ch" id="id27" name="id27">1.5&nbsp;&nbsp;&nbsp;オプションの定義はoptions.[ch]</a></li>
<li><a class="reference" href="#id5" id="id28" name="id28">1.6&nbsp;&nbsp;&nbsp;行番号は1オリジン、桁番号は0オリジン</a></li>
<li><a class="reference" href="#id6" id="id29" name="id29">1.7&nbsp;&nbsp;&nbsp;内部変数に値を代入するには</a></li>
<li><a class="reference" href="#id7" id="id30" name="id30">1.8&nbsp;&nbsp;&nbsp;Vim スクリプトの式を評価するには</a></li>
<li><a class="reference" href="#ex" id="id31" name="id31">1.9&nbsp;&nbsp;&nbsp;ex コマンドを実行するには</a></li>
<li><a class="reference" href="#id8" id="id32" name="id32">1.10&nbsp;&nbsp;&nbsp;関数メモ</a></li>
<li><a class="reference" href="#id9" id="id33" name="id33">1.11&nbsp;&nbsp;&nbsp;便利な関数</a><ul class="auto-toc">
<li><a class="reference" href="#id10" id="id34" name="id34">1.11.1&nbsp;&nbsp;&nbsp;メモリを確保してそこに文字列をコピーする</a></li>
<li><a class="reference" href="#id11" id="id35" name="id35">1.11.2&nbsp;&nbsp;&nbsp;エコーエリアにメッセージを表示する</a></li>
<li><a class="reference" href="#id12" id="id36" name="id36">1.11.3&nbsp;&nbsp;&nbsp;カレントディレクトリを変更する</a></li>
<li><a class="reference" href="#id13" id="id37" name="id37">1.11.4&nbsp;&nbsp;&nbsp;空白文字をスキップする</a></li>
<li><a class="reference" href="#id14" id="id38" name="id38">1.11.5&nbsp;&nbsp;&nbsp;カーソルを前後に移動させる</a></li>
</ul>
</li>
<li><a class="reference" href="#id15" id="id39" name="id39">1.12&nbsp;&nbsp;&nbsp;マルチバイト関連</a><ul class="auto-toc">
<li><a class="reference" href="#mb-head-off" id="id40" name="id40">1.12.1&nbsp;&nbsp;&nbsp;mb_head_off</a></li>
</ul>
</li>
<li><a class="reference" href="#id16" id="id41" name="id41">1.13&nbsp;&nbsp;&nbsp;キー入力関連</a><ul class="auto-toc">
<li><a class="reference" href="#id17" id="id42" name="id42">1.13.1&nbsp;&nbsp;&nbsp;データ構造</a></li>
<li><a class="reference" href="#id18" id="id43" name="id43">1.13.2&nbsp;&nbsp;&nbsp;インサートモードでの入力</a></li>
<li><a class="reference" href="#id19" id="id44" name="id44">1.13.3&nbsp;&nbsp;&nbsp;マッピングの展開</a></li>
<li><a class="reference" href="#ctrl-c" id="id45" name="id45">1.13.4&nbsp;&nbsp;&nbsp;CTRL-C チェック</a></li>
</ul>
</li>
<li><a class="reference" href="#id20" id="id46" name="id46">1.14&nbsp;&nbsp;&nbsp;その他</a><ul class="auto-toc">
<li><a class="reference" href="#id21" id="id47" name="id47">1.14.1&nbsp;&nbsp;&nbsp;バッファ内の全文字をなめる</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id22" id="id3" name="id3">1&nbsp;&nbsp;&nbsp;メモ</a></h1>
<div class="section">
<h2><a class="toc-backref" href="#id23" id="id4" name="id4">1.1&nbsp;&nbsp;&nbsp;vim の自動テストを実行するには</a></h2>
<pre class="literal-block">
make test
</pre>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id24" id="nv-xxx" name="nv-xxx">1.2&nbsp;&nbsp;&nbsp;ノーマルモードコマンドの定義はnv_xxx</a></h2>
<p>ノーマルモードのコマンド xxx は大体 normal.c の nv_xxx という関数で実装されている。</p>
<table border="1" class="docutils">
<caption>例</caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">関数名</th>
<th class="head">コマンド</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>nv_page</td>
<td>CTRL-F / CTRL-B</td>
</tr>
<tr><td>nv_goto</td>
<td>gf</td>
</tr>
</tbody>
</table>
<p>ノーマルモードコマンドに対応する関数を探すには、ex コマンドラインから:</p>
<pre class="literal-block">
:ta nv_
</pre>
<p>と打って、&lt;C-d&gt; で補完してみるとよい(もちろん事前に tags を作っておく必要がある)。</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id25" id="ex-ex-c" name="ex-ex-c">1.3&nbsp;&nbsp;&nbsp;ex コマンドの定義は ex_*.c</a></h2>
<p>ex コマンドは ex_cmds.c, ex_cmds2.c, ex_docmd.c で実装されている。
分け方はよくわからない。
ex モードでの補完などコマンドライン編集は ex_getln.c にある。</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id26" id="edit-c" name="edit-c">1.4&nbsp;&nbsp;&nbsp;インサートモードコマンドは edit.c</a></h2>
<p>例えば i_CTRL-X_CTRL-F (ファイル名補完)はここで実現している。:</p>
<pre class="literal-block">
  case CTRL_X_FILES:
      if (expand_wildcards(1, &amp;compl_pattern, &amp;num_matches, &amp;matches,
          EW_FILE|EW_DIR|EW_ADDSLASH|EW_SILENT) == OK)
      {

    /* May change home directory back to &quot;~&quot;. */
    tilde_replace(compl_pattern, num_matches, matches);
    ins_compl_add_matches(num_matches, matches,
#ifdef CASE_INSENSITIVE_FILENAME
      TRUE
#else
      FALSE
#endif
      );
      }
      break;
</pre>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id27" id="options-ch" name="options-ch">1.5&nbsp;&nbsp;&nbsp;オプションの定義はoptions.[ch]</a></h2>
<ul class="simple">
<li>グローバルオプションの値は option.h の p_xxx という変数で保持している。</li>
<li>バッファローカルオプションは buf_T の b_p_xxx。</li>
<li>ウィンドウローカルオプションは winopt_T の w_p_xxx。</li>
</ul>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id28" id="id5" name="id5">1.6&nbsp;&nbsp;&nbsp;行番号は1オリジン、桁番号は0オリジン</a></h2>
<pre class="literal-block">
typedef struct
{
    linenr_T    lnum; /* 行番号(1オリジン) */
    colnr_T     col;  /* 桁番号(0オリジン) */
#ifdef FEAT_VIRTUALEDIT
    colnr_T     coladd;
#endif
} pos_T;
</pre>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id29" id="id6" name="id6">1.7&nbsp;&nbsp;&nbsp;内部変数に値を代入するには</a></h2>
<pre class="literal-block">
// v:lnum に数値を代入する
set_vim_var_nr(VV_LNUM, lnum);

// v:char に文字列を代入する
set_vim_var_string(VV_CHAR, buf, -1);
</pre>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id30" id="id7" name="id7">1.8&nbsp;&nbsp;&nbsp;Vim スクリプトの式を評価するには</a></h2>
<pre class="literal-block">
int         r;
r = eval_to_number(curbuf-&gt;b_p_fex);
</pre>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id31" id="ex" name="ex">1.9&nbsp;&nbsp;&nbsp;ex コマンドを実行するには</a></h2>
<p>do_cmdline_cmdを使うと簡単。</p>
<pre class="literal-block">
do_cmdline_cmd(&quot;tag do_cmdline_cmd&quot;);
</pre>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id32" id="id8" name="id8">1.10&nbsp;&nbsp;&nbsp;関数メモ</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr><td>enter_buffer</td>
<td>バッファに入ったとき実行される。</td>
</tr>
<tr><td>echo_string</td>
<td>toString()に相当。</td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id33" id="id9" name="id9">1.11&nbsp;&nbsp;&nbsp;便利な関数</a></h2>
<div class="section">
<h3><a class="toc-backref" href="#id34" id="id10" name="id10">1.11.1&nbsp;&nbsp;&nbsp;メモリを確保してそこに文字列をコピーする</a></h3>
<p>strdup() と同じ。</p>
<pre class="literal-block">
buf-&gt;b_p_inde = vim_strsave(p_inde);
</pre>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id35" id="id11" name="id11">1.11.2&nbsp;&nbsp;&nbsp;エコーエリアにメッセージを表示する</a></h3>
<p>printf() と同じフォーマットを受け付ける。</p>
<pre class="literal-block">
smsg(char_u *s, ...)
</pre>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id36" id="id12" name="id12">1.11.3&nbsp;&nbsp;&nbsp;カレントディレクトリを変更する</a></h3>
<pre class="literal-block">
    int
vim_chdir(new_dir)
    char_u    *new_dir;
</pre>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id37" id="id13" name="id13">1.11.4&nbsp;&nbsp;&nbsp;空白文字をスキップする</a></h3>
<pre class="literal-block">
char_u *s = skipwhite(p);
</pre>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id38" id="id14" name="id14">1.11.5&nbsp;&nbsp;&nbsp;カーソルを前後に移動させる</a></h3>
<p>misc2.c の inc_cursor() と dec_cursor();</p>
</div>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id39" id="id15" name="id15">1.12&nbsp;&nbsp;&nbsp;マルチバイト関連</a></h2>
<div class="section">
<h3><a class="toc-backref" href="#id40" id="mb-head-off" name="mb-head-off">1.12.1&nbsp;&nbsp;&nbsp;mb_head_off</a></h3>
<p>文字列中の指定したバイトが、マルチバイト文字の何バイト目かを返す。
カーソルがマルチバイト文字の中間に置かれてしまうのを避けるために使われる。</p>
<pre class="literal-block">
              --pos.col;
#ifdef FEAT_MBYTE
              if (has_mbyte)
                  pos.col -= (*mb_head_off)(linep, linep + pos.col);
#endif
</pre>
</div>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id41" id="id16" name="id16">1.13&nbsp;&nbsp;&nbsp;キー入力関連</a></h2>
<div class="section">
<h3><a class="toc-backref" href="#id42" id="id17" name="id17">1.13.1&nbsp;&nbsp;&nbsp;データ構造</a></h3>
<pre class="literal-block">
static char_u inbuf[INBUFLEN + MAX_KEY_CODE_LEN];     // vim の入力バッファ
static int    inbufcount = 0;     /* number of chars in inbuf[] */

EXTERN typebuf_T typebuf              /* typeahead buffer */
/*
 * Used for the typeahead buffer: typebuf.
 */
typedef struct
{
    char_u    *tb_buf;        /* buffer for typed characters */
    char_u    *tb_noremap;    /* mapping flags for characters in tb_buf[] */
    int               tb_buflen;      /* size of tb_buf[] */
    int               tb_off;         /* current position in tb_buf[] */
    int               tb_len;         /* number of valid bytes in tb_buf[] */
    int               tb_maplen;      /* nr of mapped bytes in tb_buf[] */
    int               tb_silent;      /* nr of silently mapped bytes in tb_buf[] */
    int               tb_no_abbr_cnt; /* nr of bytes without abbrev. in tb_buf[] */
    int               tb_change_cnt;  /* nr of time tb_buf was changed; never zero */
} typebuf_T;

// stuff buffer はプログラム内部からキー入力をエミュレートするために使われるバッファ。
// ただしキー入力とは扱いが異なる点もある。(KeyStuffedでgrepせよ)
// 例えば . やリドゥのときはリドゥバッファからstuff bufferへコピーされる。(:ta nv_dot)
EXTERN struct buffheader stuffbuff    /* stuff buffer */
/*
 * header used for the stuff buffer and the redo buffer
 */
struct buffheader
{
    struct buffblock  bh_first;       /* first (dummy) block of list */
    struct buffblock  *bh_curr;       /* buffblock for appending */
    int                       bh_index;       /* index for reading */
    int                       bh_space;       /* space in bh_curr for appending */
};
</pre>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id43" id="id18" name="id18">1.13.2&nbsp;&nbsp;&nbsp;インサートモードでの入力</a></h3>
<p>インサートモードでの入力は、edit.c : insertchar() → vgetc()</p>
<pre class="literal-block">
+-vgetc() &lt;int vgetc () at getchar.c:1503&gt;
  +-garbage_collect()
  +-vgetorpeek()
    +-get_real_state()
    +-init_typebuf() &lt;void init_typebuf () at getchar.c:878&gt; // typebuf.ty_buf が NULL のときだけ初期化する
    +-start_stuff() &lt;void start_stuff () at getchar.c:390&gt;
    +-read_stuff()
    +-line_breakcheck()
    +-ui_breakcheck()
    +-inchar()        // キー取得（:source! による入力も含む）
      | (略)
      +-gui_update_cursor()
      +-update_mouseshape()
      +-ui_inchar()     // 読み込んだ文字数を返す
        +-mch_inchar() // os_unix.c などプラットフォームごとに定義
          +-handle_resize()
          +-WaitForChar() // 文字が入力可能になるまで待つ
          | +-input_available() // input buffer または typeahead buffer に文字がたまっているなら true
          | +-mch_write()
          | | (略)
          | +-RealWaitForChar() // 1文字が読み込み可能になるまで待つ。os_unix.c では ret = select(maxfd + 1, &amp;rfds, NULL, &amp;efds, tvp); select() が使えないシステムでは poll() を使っている。sniff インターフェイス、xclipboardなどいろんなところから文字を取ろうとしている。
          |   +-mzthreads_allowed() // mzscheme はかなり内部まで食い込んでいることがわかる
          |   +-gettimeofday()
          |   +-mzvim_check_threads()
          |   +-ConnectionNumber()
          |   +-poll()
          |   +-sniff_disconnect()  // sniff も
          |   +-xterm_update() &lt;void xterm_update () at os_unix.c:6216&gt;
          |   | +-XtAppPending()
          |   | +-vim_is_input_buf_full()
          |   | +-XtAppNextEvent()
          |   | +-serverEventProc()
          |   | \-XtDispatchEvent()
          |   +-input_available()
          +-trigger_cursorhold() // CursorHold を発生させられるかどうか。発生はさせないので注意。
          +-typebuf_changed()
          +-before_blocking()
          \-read_from_input_buf() // キー入力を読み込む
            +-fill_input_buf()    // read(2) で inbuf にキー入力を読み込み、CTRL-C チェックを行う。
               +-no_console_input()
               +-gui_mch_update()
               +-vim_is_input_buf_full() &lt;int vim_is_input_buf_full () at ui.c:1529&gt;
               +-RealWaitForChar()
               +-add_to_input_buf()
               +-mch_memmove()
               +-vim_free()
               +-vms_read()
               +-read()
               +-isatty()
               +-settmode() // 端末のモード設定(tcsetattr)
               +-close()
               +-dup()
               +-read_error_exit() &lt;void read_error_exit () at ui.c:1884&gt;
                 +-getout()
                 +-STRCPY()
                 \-preserve_exit()
               \-convert_input_safe()
                   +-typebuf_changed()
      \-fix_input_buffer()      // NUL, K_SPECIAL, CSI の各文字を3バイトのコードに置換する
        +-mch_memmove()
        +-K_THIRD()
        \-K_SECOND()
</pre>
<p>read(2) で読み取ったキーはまず inbuf に格納され、read_from_input_buf() により typebuf にコピーされる。</p>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id44" id="id19" name="id19">1.13.3&nbsp;&nbsp;&nbsp;マッピングの展開</a></h3>
<p>マッピングの展開はvgetorpeek()の以下のところでやっている。</p>
<pre class="literal-block">
/*
    * Loop until a partly matching mapping is found or
    * all (local) mappings have been checked.
    * The longest full match is remembered in &quot;mp_match&quot;.
    * A full match is only accepted if there is no partly
    * match, so &quot;aa&quot; and &quot;aaa&quot; can both be mapped.
    */
</pre>
<p>短縮入力の展開はもっとあと。edit()→ins_tab()などの中。</p>
</div>
<div class="section">
<h3><a class="toc-backref" href="#id45" id="ctrl-c" name="ctrl-c">1.13.4&nbsp;&nbsp;&nbsp;CTRL-C チェック</a></h3>
<p>:tag などのコマンドを実行している最中に CTRL-C を押すとコマンドを中断できる。
これは do_tag() の中で ui_breakcheck() を呼んで、CTRL-C 押下をチェックしているため。</p>
<pre class="literal-block">
ui_breakcheck()
  +-mcn_breakcheck()
    +-fill_input_buf(FALSE) // read(2) で inbuf にキー入力を読み込み、CTRL-C チェックを行う。
</pre>
</div>
</div>
<div class="section">
<h3>インサートモードでの補完。補完結果をバッファへ挿入する</h3>
<p>
この処理を見ると、補完候補に改行を含めることは不可能。今後も見込みなしと思われる。
</p>
<pre class="literal-block">
  # TO tag         FROM line  in file/text
  1  1 ins_complete     1348  edit.c
  2  1 ins_compl_next   5070  edit.c
  3  1 ins_compl_insert  4485  edit.c
  4  1 ins_bytes        4318  edit.c
  5  1 ins_bytes_len    1862  ins_bytes_len(p, (int)STRLEN(p));
  6  1 ins_char_bytes   1889  ins_char_bytes(p + i, n);</pre>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id46" id="id20" name="id20">1.14&nbsp;&nbsp;&nbsp;その他</a></h2>
<div class="section">
<h3><a class="toc-backref" href="#id47" id="id21" name="id21">1.14.1&nbsp;&nbsp;&nbsp;バッファ内の全文字をなめる</a></h3>
<p>カーソル位置からバッファの先頭に向かって全文字を調べていくにはこんな感じ。
多少遅くなってもよければ、inc() と dec() を使ってもいい。</p>
<pre class="literal-block">
while (1)
{
    if (backwards)
    {
        if (pos.col == 0)       /* at start of line, go to prev. one */
        {
            if (pos.lnum == 1)  /* start of file */
                break;
            --pos.lnum;
            linep = ml_get(pos.lnum);
            pos.col = (colnr_T)STRLEN(linep); /* pos.col on trailing NUL */
        }
        else
        {
            --pos.col;
    #ifdef FEAT_MBYTE
            if (has_mbyte)
                pos.col -= (*mb_head_off)(linep, linep + pos.col);
    #endif
        }
    }
    // ここで linep[pos.col] が現在見ている文字
}
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
